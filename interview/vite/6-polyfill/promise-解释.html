<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promise polyfill è¯¦ç»†è§£é‡Š</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 { color: #333; }
        code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            color: #e83e8c;
        }
        .output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>ğŸ¯ Promise polyfill è¯¦ç»†è§£é‡Š</h1>

    <div class="section">
        <h2>1ï¸âƒ£ ä¸ºä»€ä¹ˆè¦è¿”å› thisï¼Ÿ</h2>
        <p><strong>ç­”æ¡ˆï¼šä¸ºäº†å®ç°é“¾å¼è°ƒç”¨ï¼ˆMethod Chainingï¼‰</strong></p>
        <p>è¿”å› <code>this</code> å°±æ˜¯è¿”å›å½“å‰å¯¹è±¡æœ¬èº«ï¼Œè¿™æ ·å°±å¯ä»¥ç»§ç»­è°ƒç”¨è¯¥å¯¹è±¡çš„æ–¹æ³•ã€‚</p>
    </div>

    <div class="section">
        <h2>2ï¸âƒ£ ä¸è¿”å› this çš„é—®é¢˜</h2>
        <div class="output" id="output1">è¿è¡Œæµ‹è¯•ä¸­...</div>
    </div>

    <div class="section">
        <h2>3ï¸âƒ£ è¿”å› this çš„å¥½å¤„</h2>
        <div class="output" id="output2">è¿è¡Œæµ‹è¯•ä¸­...</div>
    </div>

    <div class="section">
        <h2>4ï¸âƒ£ å®Œæ•´çš„ç®€åŒ– Promise ç¤ºä¾‹</h2>
        <div class="output" id="output3">è¿è¡Œæµ‹è¯•ä¸­...</div>
    </div>

    <script>
        console.clear();
        
        // ==========================================
        // ç¤ºä¾‹ 1ï¼šä¸è¿”å› this çš„é—®é¢˜
        // ==========================================
        console.log('=== ç¤ºä¾‹ 1ï¼šä¸è¿”å› this ===');
        
        function MyPromiseNoReturn() {
            let callback;
            
            // âŒ æ²¡æœ‰è¿”å› this
            this.then = function(cb) {
                callback = cb;
                // æ²¡æœ‰è¿”å›ä»»ä½•ä¸œè¥¿
            }
            
            this.resolve = function(value) {
                if (callback) callback(value);
            }
        }
        
        try {
            const p1 = new MyPromiseNoReturn();
            // âŒ è¿™æ ·ä¼šæŠ¥é”™ï¼Œå› ä¸º then() è¿”å› undefined
            // p1.then(x => x + 1).then(x => x * 2); // æŠ¥é”™ï¼
            
            // åªèƒ½è¿™æ ·ä½¿ç”¨ï¼ˆä¸èƒ½é“¾å¼è°ƒç”¨ï¼‰
            p1.then(value => {
                document.getElementById('output1').innerHTML = `
                    âŒ ä¸èƒ½é“¾å¼è°ƒç”¨çš„ä¾‹å­ï¼š<br>
                    const p = new MyPromiseNoReturn();<br>
                    p.then(callback); // âœ… å¯ä»¥<br>
                    p.then(cb1).then(cb2); // âŒ æŠ¥é”™ï¼<br><br>
                    å› ä¸º then() æ²¡æœ‰è¿”å›å€¼ï¼ˆè¿”å› undefinedï¼‰<br>
                    undefined.then() ä¼šæŠ¥é”™ï¼
                `;
                console.log('æ”¶åˆ°å€¼:', value);
            });
            
            setTimeout(() => p1.resolve(100), 100);
        } catch (e) {
            console.error('é”™è¯¯:', e);
        }

        // ==========================================
        // ç¤ºä¾‹ 2ï¼šè¿”å› this å®ç°é“¾å¼è°ƒç”¨
        // ==========================================
        console.log('\n=== ç¤ºä¾‹ 2ï¼šè¿”å› this ===');
        
        function MyPromiseWithReturn() {
            let callback;
            
            // âœ… è¿”å› this
            this.then = function(cb) {
                callback = cb;
                return this; // ğŸ”‘ å…³é”®ï¼šè¿”å›å½“å‰å¯¹è±¡
            }
            
            this.resolve = function(value) {
                if (callback) callback(value);
            }
        }
        
        const p2 = new MyPromiseWithReturn();
        
        // âœ… ç°åœ¨å¯ä»¥é“¾å¼è°ƒç”¨äº†ï¼
        p2
            .then(value => {
                console.log('ç¬¬ä¸€ä¸ª then:', value);
                return value;
            })
            .then(value => {
                console.log('ç¬¬äºŒä¸ª then:', value);
                return value;
            })
            .then(value => {
                console.log('ç¬¬ä¸‰ä¸ª then:', value);
                document.getElementById('output2').innerHTML = `
                    âœ… å¯ä»¥é“¾å¼è°ƒç”¨çš„ä¾‹å­ï¼š<br>
                    const p = new MyPromiseWithReturn();<br>
                    p.then(cb1).then(cb2).then(cb3); // âœ… æˆåŠŸï¼<br><br>
                    
                    <strong>åŸç†ï¼š</strong><br>
                    p.then(cb1) è¿”å› pï¼ˆthisï¼‰<br>
                    â†“<br>
                    p.then(cb2) è¿”å› pï¼ˆthisï¼‰<br>
                    â†“<br>
                    p.then(cb3) è¿”å› pï¼ˆthisï¼‰<br><br>
                    
                    æ¯æ¬¡éƒ½è¿”å›åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥ä¸€ç›´è°ƒç”¨ä¸‹å»ï¼
                `;
            });
        
        setTimeout(() => p2.resolve(200), 200);

        // ==========================================
        // ç¤ºä¾‹ 3ï¼šæ›´å®Œæ•´çš„ Promise polyfill
        // ==========================================
        console.log('\n=== ç¤ºä¾‹ 3ï¼šæ›´å®Œæ•´çš„å®ç° ===');
        
        function SimplePromise(executor) {
            let onResolve = null;
            let value = null;
            let isResolved = false;
            
            // then æ–¹æ³•ï¼šæ³¨å†Œå›è°ƒå¹¶è¿”å› this
            this.then = function(callback) {
                onResolve = callback;
                
                // å¦‚æœå·²ç» resolve äº†ï¼Œç«‹å³æ‰§è¡Œå›è°ƒ
                if (isResolved) {
                    onResolve(value);
                }
                
                return this; // ğŸ”‘ è¿”å› this å®ç°é“¾å¼è°ƒç”¨
            }
            
            // resolve æ–¹æ³•ï¼šè§¦å‘å›è°ƒ
            const resolve = (val) => {
                value = val;
                isResolved = true;
                
                if (onResolve) {
                    onResolve(value);
                }
            }
            
            // ç«‹å³æ‰§è¡Œ executor
            try {
                executor(resolve);
            } catch (e) {
                console.error('æ‰§è¡Œå‡ºé”™:', e);
            }
        }
        
        // ä½¿ç”¨ç¤ºä¾‹
        const p3 = new SimplePromise((resolve) => {
            console.log('Promise å¼€å§‹æ‰§è¡Œ...');
            setTimeout(() => {
                console.log('2ç§’å resolve');
                resolve('å®Œæˆï¼');
            }, 2000);
        });
        
        // é“¾å¼è°ƒç”¨
        p3
            .then(result => {
                console.log('ç¬¬1æ¬¡å¤„ç†:', result);
                document.getElementById('output3').innerHTML = `
                    âœ… å®Œæ•´çš„ Promise ç¤ºä¾‹ï¼š<br><br>
                    
                    <strong>ä»£ç ï¼š</strong><br>
                    const p = new SimplePromise((resolve) => {<br>
                    &nbsp;&nbsp;setTimeout(() => resolve('å®Œæˆï¼'), 2000);<br>
                    });<br><br>
                    
                    p.then(result => console.log(result));<br><br>
                    
                    <strong>æ‰§è¡Œç»“æœï¼š</strong><br>
                    ${result}<br><br>
                    
                    <strong>å…³é”®ç‚¹ï¼š</strong><br>
                    1. executor ç«‹å³æ‰§è¡Œ<br>
                    2. then() æ³¨å†Œå›è°ƒå‡½æ•°<br>
                    3. resolve() è§¦å‘å›è°ƒ<br>
                    4. then() è¿”å› this æ”¯æŒé“¾å¼è°ƒç”¨
                `;
                return result;
            });

        // ==========================================
        // å¯¹æ¯”çœŸå®çš„ Promise
        // ==========================================
        console.log('\n=== çœŸå®çš„ Promise å¯¹æ¯” ===');
        
        const realPromise = new Promise((resolve) => {
            setTimeout(() => resolve('çœŸå® Promise'), 100);
        });
        
        // çœŸå®çš„ Promise ä¹Ÿæ”¯æŒé“¾å¼è°ƒç”¨
        realPromise
            .then(value => {
                console.log('çœŸå® Promise ç¬¬1ä¸ª then:', value);
                return value + ' -> ç¬¬2æ­¥';
            })
            .then(value => {
                console.log('çœŸå® Promise ç¬¬2ä¸ª then:', value);
                return value + ' -> ç¬¬3æ­¥';
            })
            .then(value => {
                console.log('çœŸå® Promise ç¬¬3ä¸ª then:', value);
            });

        // ==========================================
        // ç±»æ¯”ï¼šjQuery çš„é“¾å¼è°ƒç”¨
        // ==========================================
        console.log('\n=== ç±»æ¯”ï¼šå…¶ä»–é“¾å¼è°ƒç”¨çš„ä¾‹å­ ===');
        
        // æ¨¡æ‹Ÿ jQuery é£æ ¼çš„é“¾å¼è°ƒç”¨
        function MyElement(selector) {
            this.element = selector;
            
            this.css = function(prop, value) {
                console.log(`è®¾ç½® ${prop}: ${value}`);
                return this; // è¿”å› this å®ç°é“¾å¼è°ƒç”¨
            }
            
            this.addClass = function(className) {
                console.log(`æ·»åŠ ç±»: ${className}`);
                return this; // è¿”å› this å®ç°é“¾å¼è°ƒç”¨
            }
            
            this.show = function() {
                console.log('æ˜¾ç¤ºå…ƒç´ ');
                return this; // è¿”å› this å®ç°é“¾å¼è°ƒç”¨
            }
        }
        
        // é“¾å¼è°ƒç”¨ç¤ºä¾‹
        new MyElement('.box')
            .css('color', 'red')
            .addClass('active')
            .show();
        
        console.log('\nâœ… é“¾å¼è°ƒç”¨çš„æ ¸å¿ƒï¼šæ¯ä¸ªæ–¹æ³•éƒ½è¿”å› thisï¼ˆå½“å‰å¯¹è±¡ï¼‰');
    </script>
</body>
</html>

